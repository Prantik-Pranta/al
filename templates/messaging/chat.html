{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block title %}Chat{% endblock %}

{% block extra_css %}
<style>
  .chat-wrapper {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    background: var(--surface);
  }
  .chat-header {
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: space-between;
  }
  .chat-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .chat-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
  }
  .chat-body {
    height: 60vh;
    overflow-y: auto;
    padding: 20px;
    background: var(--surface);
  }
  .bubble {
    max-width: 70%;
    margin-bottom: 16px;
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.4;
  }
  .me {
    margin-left: auto;
    background: var(--primary-light);
    border: 1px solid var(--primary);
  }
  .them {
    margin-right: auto;
    background: var(--bg);
    border: 1px solid var(--border);
  }
  .chat-time {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
  }
  .chat-input {
    border-top: 1px solid var(--border);
    background: var(--bg);
    padding: 16px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12 col-lg-8 mx-auto">
      <div class="chat-wrapper">

        <!-- Header -->
        <div class="chat-header">
          <div class="chat-header-left">
            <a href="{% url 'inbox' %}" class="btn btn-sm btn-outline-secondary">
              <i class="fa-solid fa-arrow-left"></i>
            </a>
            <img
              class="chat-avatar"
              src="{% if other_user.userprofile and other_user.userprofile.profile_photo %}{{ other_user.userprofile.profile_photo.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}"
              alt="{{ other_user.get_full_name|default:other_user.username }}"
            >
            <div>
              <div class="fw-semibold">{{ other_user.get_full_name|default:other_user.username }}</div>
              {% if other_user.userprofile %}
                <small class="text-muted">
                  {% if other_user.userprofile.headline %}
                    {{ other_user.userprofile.headline }}
                  {% else %}
                    {% if other_user.userprofile.is_alumni %}Alumni{% else %}Student{% endif %}
                  {% endif %}
                </small>
              {% endif %}
            </div>
          </div>

          <!-- Meet + Schedule actions -->
          <div class="chat-actions">
            <a href="{% url 'chat_start_meeting' other_user.id %}" class="btn btn-sm btn-primary">
              <i class="fa-solid fa-video me-1"></i> Meet
            </a>
            {% if other_user.userprofile and other_user.userprofile.is_alumni %}
              <a href="{% url 'availability_list' %}" class="btn btn-sm btn-outline-primary">
                <i class="fa-regular fa-calendar me-1"></i> Schedule
              </a>
            {% endif %}
          </div>
        </div>

        <!-- Body -->
        <div class="chat-body" id="chatBody">
          {% for m in messages %}
            {% if m.sender_id == request.user.id %}
              <div class="bubble me">
                {{ m.content }}
                <div class="chat-time text-end">{{ m.timestamp|naturaltime }}</div>
              </div>
            {% else %}
              <div class="bubble them">
                {{ m.content }}
                <div class="chat-time">{{ m.timestamp|naturaltime }}</div>
              </div>
            {% endif %}
          {% empty %}
            <div class="text-center text-muted py-5">
              <i class="fa-regular fa-comments fa-2x mb-3"></i>
              <p class="mb-0">Say hello to start the conversation ðŸ‘‹</p>
            </div>
          {% endfor %}
        </div>

        <!-- Input -->
        <form method="post" class="chat-input">
          {% csrf_token %}
          <div class="input-group">
            <input type="text" name="message" class="form-control" placeholder="Type a messageâ€¦" autocomplete="off" required>
            <button class="btn btn-primary" type="submit">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // auto-scroll to bottom
  (function(){
    const el = document.getElementById('chatBody');
    if (el) el.scrollTop = el.scrollHeight;
  })();
</script>
{% endblock %}